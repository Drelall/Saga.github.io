import GoogleDriveStorage from './google-drive-storage.js';

// Instance du gestionnaire de stockage
const storage = new GoogleDriveStorage();

// Variables globales
let rpList = [];
let currentPage = 'active';
let currentFilter = 'all';
let currentSort = 'time-desc';

console.log('üì¶ Renderer charg√©');

// Sauvegarder les donn√©es sur Google Drive uniquement
async function saveData() {
    console.log('üíæ Sauvegarde des donn√©es...', rpList.length, 'RPs');
    await storage.saveData(rpList);
    console.log('‚úÖ Sauvegarde r√©ussie sur Google Drive');
}

// Charger les donn√©es depuis Google Drive uniquement
async function loadData() {
    console.log('üì• Chargement des donn√©es...');
    rpList = await storage.loadData();
    console.log('‚úÖ Chargement r√©ussi depuis Google Drive:', rpList.length, 'RPs');
}

// Afficher notification
function showNotification(message, type = 'success') {
    console.log(`üîî Notification ${type}:`, message);
    
    const container = document.getElementById('notifications');
    if (!container) return;
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    container.appendChild(notification);
    
    setTimeout(() => notification.classList.add('show'), 100);
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Obtenir RPs actifs
function getActiveRPs() {
    return rpList.filter(rp => rp.turn !== 'RP termin√©' && rp.turn !== 'RP abandonn√©');
}

// Calculer temps √©coul√©
function getTimeDisplay(date) {
    if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
        return { timeStr: 'Date invalide', className: 'time-normal' };
    }
    
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffMinutes = Math.floor(diffMs / (1000 * 60));
    
    let timeStr = '';
    let className = 'time-normal';
    
    if (diffDays > 0) {
        timeStr = `Il y a ${diffDays} jour${diffDays > 1 ? 's' : ''}`;
        if (diffDays >= 7) className = 'time-urgent';
        else if (diffDays >= 3) className = 'time-warning';
    } else if (diffHours > 0) {
        timeStr = `Il y a ${diffHours} heure${diffHours > 1 ? 's' : ''}`;
    } else if (diffMinutes > 0) {
        timeStr = `Il y a ${diffMinutes} minute${diffMinutes > 1 ? 's' : ''}`;
    } else {
        timeStr = '√Ä l\'instant';
    }
    
    return { timeStr, className };
}

// Cr√©er carte RP
function createCard(item) {
    const { timeStr, className } = getTimeDisplay(item.date);
    
    let statusClass = '';
    let statusText = '';
    
    switch(item.turn) {
        case "√Ä ton partenaire de poster":
            statusClass = 'turn-partner';
            statusText = 'En attente de votre partenaire';
            break;
        case "√Ä toi de poster":
            statusClass = 'turn-you';
            statusText = '√Ä vous de poster';
            break;
        case "RP termin√©":
            statusClass = 'turn-completed';
            statusText = 'RP termin√©';
            break;
        case "RP abandonn√©":
            statusClass = 'turn-abandoned';
            statusText = 'RP abandonn√©';
            break;
    }

    const card = document.createElement('div');
    card.className = 'rp-card';
    card.dataset.id = item.id;
    card.innerHTML = `
        <div class="card-header ${statusClass}">
            <div class="card-title-container">
                <h3 class="card-title">${item.rp}</h3>
            </div>
            <div class="card-status ${statusClass}">
                <span>${statusText}</span>
            </div>
        </div>
        
        <div class="card-body">
            <div class="card-info">
                <div class="info-item">
                    <span class="info-label">Partenaire</span>
                    <span class="info-value">${item.partner}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Lieu</span>
                    <span class="info-value">${item.location || 'Non sp√©cifi√©'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Type</span>
                    <span class="info-value">${item.type || 'Non sp√©cifi√©'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Univers</span>
                    <span class="info-value">${item.universe || 'Non sp√©cifi√©'}</span>
                </div>
            </div>
            
            <div class="card-time">
                <span class="time-icon">üïò</span>
                <span class="time-text ${className}">${timeStr}</span>
            </div>
            
            <div class="card-actions">
                <button class="btn btn-secondary btn-sm edit-btn" data-id="${item.id}">
                    ‚úèÔ∏è Modifier
                </button>
                <button class="btn btn-danger btn-sm delete-btn" data-id="${item.id}">
                    üóëÔ∏è Supprimer
                </button>
            </div>
        </div>
    `;
    
    return card;
}

// Mettre √† jour affichage cartes
function updateActiveCards() {
    console.log('üîÑ Mise √† jour cartes actives...');
    
    const cardsView = document.getElementById('cards-view');
    const cardsEmptyState = document.getElementById('cards-empty-state');
    
    if (!cardsView) {
        console.error('‚ùå √âl√©ment cards-view non trouv√©');
        return;
    }
    
    cardsView.innerHTML = '';
    const activeRPs = getActiveRPs();
    
    console.log('üìä RPs actifs:', activeRPs.length);
    
    if (activeRPs.length === 0) {
        cardsView.style.display = 'none';
        if (cardsEmptyState) {
            cardsEmptyState.style.display = 'block';
        }
        return;
    }
    
    cardsView.style.display = 'grid';
    if (cardsEmptyState) {
        cardsEmptyState.style.display = 'none';
    }
    
    // Appliquer filtres et tri
    let filteredList = activeRPs;
    
    if (currentFilter !== 'all') {
        filteredList = activeRPs.filter(item => item.turn === currentFilter);
    }
    
    // Trier
    if (currentSort === 'time-desc') {
        filteredList.sort((a, b) => b.date - a.date);
    } else if (currentSort === 'time-asc') {
        filteredList.sort((a, b) => a.date - b.date);
    }
    
    // Cr√©er cartes
    filteredList.forEach((item) => {
        const card = createCard(item);
        cardsView.appendChild(card);
    });
    
    // Attacher √©v√©nements
    attachCardEvents();
    
    console.log('‚úÖ Cartes mises √† jour:', filteredList.length, 'affich√©es');
}

// Attacher √©v√©nements aux cartes
function attachCardEvents() {
    // Boutons supprimer
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            const item = rpList.find(rp => rp.id == id);
            
            if (item && confirm(`Supprimer le RP "${item.rp}" ?`)) {
                rpList = rpList.filter(rp => rp.id != id);
                await saveData();
                updateActiveCards();
                showNotification(`RP "${item.rp}" supprim√©`);
            }
        });
    });
    
    // Boutons modifier
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            const item = rpList.find(rp => rp.id == id);
            
            if (item) {
                // Remplir formulaire
                document.getElementById('rpName').value = item.rp;
                document.getElementById('partnerName').value = item.partner;
                document.getElementById('rpLocation').value = item.location || '';
                document.getElementById('rpType').value = item.type || '';
                document.getElementById('rpUniverse').value = item.universe || '';
                document.getElementById('rpUrl').value = item.url || '';
                document.getElementById('turn').value = item.turn;
                
                // Supprimer de la liste
                rpList = rpList.filter(rp => rp.id != id);
                updateActiveCards();
                showNotification('RP pr√™t √† √™tre modifi√©');
            }
        });
    });
}

// Attendre connexion utilisateur ET API Google Drive
function waitForAuth() {
    return new Promise((resolve) => {
        const check = () => {
            if (window.currentUser && sessionStorage.getItem('user_id') && window.gapi && window.gapi.client) {
                console.log('‚úÖ Utilisateur connect√© et API pr√™te');
                resolve();
            } else {
                console.log('‚è≥ Attente connexion et API...');
                setTimeout(check, 1000);
            }
        };
        check();
    });
}

// Initialisation
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ Initialisation renderer...');
    
    // Gestionnaire formulaire
    const rpForm = document.getElementById('rpForm');
    if (rpForm) {
        rpForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('üìù Soumission formulaire...');

            // V√©rifier connexion
            if (!window.currentUser) {
                alert('Veuillez vous connecter pour ajouter un RP');
                return;
            }

            // R√©cup√©rer donn√©es formulaire
            const rpName = document.getElementById('rpName').value.trim();
            const partnerName = document.getElementById('partnerName').value.trim();
            const location = document.getElementById('rpLocation').value.trim();
            const type = document.getElementById('rpType').value.trim();
            const universe = document.getElementById('rpUniverse').value.trim();
            const url = document.getElementById('rpUrl').value.trim();
            const turn = document.getElementById('turn').value;

            console.log('üìã Donn√©es formulaire:', { rpName, partnerName, turn });

            if (rpName && partnerName && turn) {
                const newRP = {
                    id: Date.now() + Math.random(),
                    rp: rpName,
                    partner: partnerName,
                    location: location || '',
                    type: type || '',
                    universe: universe || '',
                    url: url || '',
                    turn: turn,
                    date: new Date()
                };

                console.log('‚ûï Ajout nouveau RP:', newRP);
                rpList.push(newRP);
                
                try {
                    await saveData();
                    updateActiveCards();
                    rpForm.reset();
                    showNotification(`RP "${rpName}" ajout√© avec succ√®s !`);
                    console.log('‚úÖ RP ajout√© avec succ√®s');
                } catch (error) {
                    console.error('‚ùå Erreur ajout RP:', error);
                    rpList.pop(); // Retirer si √©chec
                    showNotification('Erreur lors de l\'ajout', 'error');
                }
            } else {
                console.warn('‚ö†Ô∏è Champs requis manquants');
                showNotification('Veuillez remplir tous les champs requis', 'error');
            }
        });
    } else {
        console.error('‚ùå Formulaire rpForm non trouv√©');
    }

    // Navigation
    const navActive = document.getElementById('nav-active');
    if (navActive) {
        navActive.addEventListener('click', () => {
            currentPage = 'active';
            updateActiveCards();
        });
    }

    // Attendre connexion ET API Google Drive
    try {
        await waitForAuth();
        await loadData();
        updateActiveCards();
        console.log('üéâ RP Tracker initialis√© avec succ√®s');
    } catch (error) {
        console.error('‚ùå Erreur initialisation:', error);
        updateActiveCards(); // Afficher quand m√™me
    }
});